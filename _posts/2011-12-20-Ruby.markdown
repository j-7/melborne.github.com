---
layout: post
title: Rubyでデータをオブジェクト化して集計する
date: 2011-12-20
comments: true
categories:
tags: [ruby]
---

Javaでデータを集計する処理について書かれたブログを読んだよ。

[リストを項目ごとに集計する - 日々常々](http://d.hatena.ne.jp/irof/20111203/p1#c)

内容は次のようなデータがあって、

<div>
<table border='1'>
<tr>
  <th>code</th>
  <th>name</th>
  <th>value</th>
</tr>
<tr>
  <td>A01</td>
  <td>hoge</td>
  <td>100</td>
</tr>
<tr>
  <td>A01</td>
  <td>piyo</td>
  <td>200</td>
</tr>
<tr>
  <td>A02</td>
  <td>hoge</td>
  <td>300</td>
</tr>
<tr>
  <td>A03</td>
  <td>hoge</td>
  <td>400</td>
</tr>
<tr>
  <td>A03</td>
  <td>piyo</td>
  <td>500</td>
</tr>
</table>
</div>

次のような集計の結果を得たいというものだよ。

<div>
<table border='1'>
<tr>
  <th>code</th>
  <th>value</th>
</tr>
<tr>
  <td>A01</td>
  <td>300</td>
</tr>
<tr>
  <td>A02</td>
  <td>300</td>
</tr>
<tr>
  <td>A03</td>
  <td>900</td>
</tr>
</table>
</div>

僕はRubyしか知らないからRubyでやってみるけど、RubyにはEnumerable#injectがあるから集計処理は簡単にできるよ。ここではデータの読み込みからやってみることにするよ。先のデータがテキストファイルにあると仮定するよ。

まずはデータを読み込んでlabelとdataの配列に格納しよう。
{% highlight ruby %}
label, *data = ARGF.map do |line|
  line.split.map(&:strip).map { |d| d.match(/^[\d,]+$/) ? d.delete(',').to_i : d.intern }
end
label # => [:code, :name, :value]
data # => [[:A01, :hoge, 100], [:A01, :piyo, 200], [:A02, :hoge, 300], [:A03, :hoge, 400], [:A03, :piyo, 500]]
{% endhighlight %}

ここでは次のような処理をしているよ。

1. 引数として渡されるデータファイルをARGFに読み込む。
1. データの各ラインに対して、splitでデータを分ける。
1. データが数値文字なら数値に変換し、それ以外ならシンボルに変換する。
1. 先頭行の結果をlabelに、残りをdataに代入する。

次にこの配列データをオブジェクト化するよ。
{% highlight ruby %}
Product = Struct.new(*label)
products = data.map { |d| Product.new(*d) }
products # => [#<struct Product code=:A01, name=:hoge, value=100>, #<struct Product code=:A01, name=:piyo, value=200>, #<struct Product code=:A02, name=:hoge, value=300>, #<struct Product code=:A03, name=:hoge, value=400>, #<struct Product code=:A03, name=:piyo, value=500>]
{% endhighlight %}
属性だけのオブジェクトを作るのはStructが便利だね。

そして集計するよ。
{% highlight ruby %}
puts products.inject(Hash.new(0)) { |h, pr| h[pr.code] += pr.value; h }
# >> {:A01=>300, :A02=>300, :A03=>900}
{% endhighlight %}
これはもう見慣れたコードだよね。ハッシュは0で初期化されるようにして、それからinjectはハッシュhを返すように。

コードをまとめると次のようになるよ。

{% gist 1499895 account.rb %}


このコードはわりと汎用性があるんだよ。たとえば次のようなデータに適用する場合、

<div>
<table border='1'>
  <tr><th>date</th><th>category</th><th>sub</th><th>expense</th></tr>
  <tr><td>2011/1</td><td>食費</td><td>肉類</td><td>4,289</td></tr>
  <tr><td>2011/1</td><td>食費</td><td>魚介類</td><td>4,036</td></tr>
  <tr><td>2011/1</td><td>食費</td><td>野菜・果物</td><td>3,332</td></tr>
  <tr><td>2011/1</td><td>光熱費</td><td>電気代</td><td>6,689</td></tr>
  <tr><td>2011/1</td><td>光熱費</td><td>ガス代</td><td>4,792</td></tr>
  <tr><td>2011/1</td><td>光熱費</td><td>水道代</td><td>4,290</td></tr>
  <tr><td>2011/1</td><td>娯楽費</td><td>ゲーム・CD等</td><td>2,913</td></tr>
  <tr><td>2011/1</td><td>娯楽費</td><td>入場料</td><td>191</td></tr>
  <tr><td>2011/1</td><td>娯楽費</td><td>ピアノ</td><td>1200</td></tr>
  <tr><td>2011/1</td><td>娯楽費</td><td>その他</td><td>1,376</td></tr>
  <tr><td>2011/1</td><td>交通費</td><td>電車代</td><td>1,286</td></tr>
  <tr><td>2011/1</td><td>交通費</td><td>バス代</td><td>350</td></tr>
  <tr><td>2011/1</td><td>交通費</td><td>タクシー</td><td>1270</td></tr>
  <tr><td>2011/1</td><td>医療費</td><td>治療代</td><td>913</td></tr>
  <tr><td>2011/1</td><td>医療費</td><td>薬代</td><td>945</td></tr>
  <tr><td>2011/2</td><td>食費</td><td>肉類</td><td>2,186</td></tr>
  <tr><td>2011/2</td><td>食費</td><td>魚介類</td><td>1,111</td></tr>
  <tr><td>2011/2</td><td>光熱費</td><td>電気代</td><td>3,645</td></tr>
  <tr><td>2011/2</td><td>光熱費</td><td>ガス代</td><td>6,912</td></tr>
  <tr><td>2011/2</td><td>光熱費</td><td>水道代</td><td>4,123</td></tr>
  <tr><td>2011/2</td><td>娯楽費</td><td>ゲーム・CD等</td><td>5,900</td></tr>
  <tr><td>2011/2</td><td>娯楽費</td><td>ピアノ</td><td>1200</td></tr>
  <tr><td>2011/2</td><td>娯楽費</td><td>その他</td><td>3,034</td></tr>
  <tr><td>2011/2</td><td>交通費</td><td>電車代</td><td>2,286</td></tr>
  <tr><td>2011/2</td><td>交通費</td><td>バス代</td><td>450</td></tr>
  <tr><td>2011/2</td><td>交通費</td><td>タクシー</td><td>0</td></tr>
  <tr><td>2011/2</td><td>医療費</td><td>治療代</td><td>1,988</td></tr>
  <tr><td>2011/2</td><td>医療費</td><td>薬代</td><td>650</td></tr>
</table>
</div>

集計コードのラベルだけを変えればいいんだ。
{% highlight ruby %}
puts products.inject(Hash.new(0)) { |h, pr| h[pr.category] += pr.expense; h }
# >> {:食費=>14954, :光熱費=>30451, :娯楽費=>15814, :交通費=>5642, :医療費=>4496}
{% endhighlight %}

月毎の支出を見たい場合はこうするよ。
{% highlight ruby %}
puts products.inject(Hash.new(0)) { |h, pr| h[pr.date] += pr.expense; h }
# >> {:"2011/1"=>37872, :"2011/2"=>33485}
{% endhighlight %}
Rubyは便利だね!

